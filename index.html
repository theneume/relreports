<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZONE AI Relationship Report Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles based on your previous headers/footers */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #4c1d95, #3700b3);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .report-content {
            /* Adjusted for full height, with scrolling if content overflows */
            max-height: none; /* Allow content to dictate height */
            height: auto; /* Ensure it adjusts to content */
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .report-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #e0e7ff; /* Light blue-gray */
            border-top: 4px solid #4f46e5; /* Indigo-600 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Tailwind overrides/additions for consistent look */
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-purple-800 { --tw-gradient-from: #581c87; --tw-gradient-to: rgba(88, 28, 135, 0); }
        .to-indigo-900 { --tw-gradient-to: #312e81; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .hover\:shadow-3xl:hover { box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3); }
        .transform { transform: var(--tw-transform); }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .hover\:-translate-y-1:hover { --tw-translate-y: -0.25rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .report-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1.5em;
            margin-bottom: 1.5em;
        }
        .report-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-800 to-indigo-900 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full transform transition-all duration-300 hover:shadow-3xl">
        <h1 class="text-4xl font-bold text-center text-gray-900 mb-8 tracking-tight">AZONE AI Relationship Report</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="bg-indigo-50 p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-indigo-800 mb-5">Person A Details</h2>
                <div class="mb-4">
                    <label for="nameA" class="block text-indigo-700 text-sm font-medium mb-2">Name:</label>
                    <input type="text" id="nameA" class="shadow-sm appearance-none border border-indigo-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150 ease-in-out" value="John">
                </div>
                <div class="mb-4">
                    <label for="dayA" class="block text-indigo-700 text-sm font-medium mb-2">Day of Birth:</label>
                    <input type="number" id="dayA" class="shadow-sm appearance-none border border-indigo-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150 ease-in-out" min="1" max="31" value="15">
                </div>
                <div class="mb-4">
                    <label for="monthA" class="block text-indigo-700 text-sm font-medium mb-2">Month of Birth:</label>
                    <select id="monthA" class="shadow-sm appearance-none border border-indigo-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150 ease-in-out"></select>
                </div>
                <div class="mb-4">
                    <label for="yearA" class="block text-indigo-700 text-sm font-medium mb-2">Year of Birth:</label>
                    <select id="yearA" class="shadow-sm appearance-none border border-indigo-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150 ease-in-out"></select>
                </div>
                <div class="mb-4">
                    <label for="genderA" class="block text-indigo-700 text-sm font-medium mb-2">Gender:</label>
                    <select id="genderA" class="shadow-sm appearance-none border border-indigo-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150 ease-in-out">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-blue-800 mb-5">Person B Details</h2>
                <div class="mb-4">
                    <label for="nameB" class="block text-blue-700 text-sm font-medium mb-2">Name:</label>
                    <input type="text" id="nameB" class="shadow-sm appearance-none border border-blue-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" value="Mary">
                </div>
                <div class="mb-4">
                    <label for="dayB" class="block text-blue-700 text-sm font-medium mb-2">Day of Birth:</label>
                    <input type="number" id="dayB" class="shadow-sm appearance-none border border-blue-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" min="1" max="31" value="20">
                </div>
                <div class="mb-4">
                    <label for="monthB" class="block text-blue-700 text-sm font-medium mb-2">Month of Birth:</label>
                    <select id="monthB" class="shadow-sm appearance-none border border-blue-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out"></select>
                </div>
                <div class="mb-4">
                    <label for="yearB" class="block text-blue-700 text-sm font-medium mb-2">Year of Birth:</label>
                    <select id="yearB" class="shadow-sm appearance-none border border-blue-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out"></select>
                </div>
                <div class="mb-4">
                    <label for="genderB" class="block text-blue-700 text-sm font-medium mb-2">Gender:</label>
                    <select id="genderB" class="shadow-sm appearance-none border border-blue-300 rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out">
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="text-center mt-8">
            <button id="generateReportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:-translate-y-1">
                Generate Relationship Report
            </button>
        </div>

        <div id="loadingMessage" class="text-center mt-10 hidden">
            <div class="loader mx-auto"></div>
            <p class="text-gray-600 mt-3 text-lg">Brewing insights from the cosmos... Please wait.</p>
        </div>

        <div id="reportDisplayArea" class="mt-12 border-t border-gray-200 pt-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Your Personalized Relationship Report</h2>
            <div id="resultDiv" class="bg-gray-50 p-8 rounded-lg shadow-inner report-content text-gray-800 leading-relaxed text-justify">
                <p class="text-center text-gray-500">Enter details for Person A and Person B and click "Generate Report" to unveil their unique Affinity Zone relationship dynamics.</p>
            </div>
        </div>

        <!-- Moved download link outside the reportDisplayArea to prevent innerHTML issues -->
        <div class="text-center mt-6" id="downloadButtonContainer">
            <a id="downloadReportLink" href="#" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2.5 px-6 rounded-full shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:-translate-y-0.5 hidden">
                Download Report as HTML
            </a>
        </div>
    </div>

    <script>
        // --- Affinity Zones Calculation Functions ---
        function populateDateDropdowns() {
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const monthSelects = document.querySelectorAll('select[id^="month"]');
            monthSelects.forEach(select => {
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = month;
                    select.appendChild(option);
                });
            });

            const currentYear = new Date().getFullYear();
            const startYear = 1919;
            const endYear = 2030;
            const yearSelects = document.querySelectorAll('select[id^="year"]');
            yearSelects.forEach(select => {
                for (let year = endYear; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
            });

            // Set default values for initial demonstration
            if (document.getElementById('monthA')) document.getElementById('monthA').value = 7;
            if (document.getElementById('yearA')) document.getElementById('yearA').value = 1990;
            if (document.getElementById('monthB')) document.getElementById('monthB').value = 3;
            if (document.getElementById('yearB')) document.getElementById('yearB').value = 1992;
        }

        // Ensure dropdowns are populated after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', populateDateDropdowns);


        function getYearOrder(year) {
            const years = {};
            let yearOrderCounter = 1;
            for (let y = 1919; y <= 2030; y++) {
                years[y] = yearOrderCounter;
                if (yearOrderCounter === 9) {
                    yearOrderCounter = 0;
                }
                yearOrderCounter += 1;
            }
            return years.hasOwnProperty(year) ? years[year] : -1;
        }

        function getMonthRow(day, month, year) {
            const tableRanges = [
                { "row": 0, "from": { month: 1, day: 1 }, "to": { month: 1, day: 5 } },
                { "row": 1, "from": { month: 1, day: 6 }, "to": { month: 2, day: 3 } },
                { "row": 2, "from": { month: 2, day: 4 }, "to": { month: 3, day: 5 } },
                { "row": 3, "from": { month: 3, day: 6 }, "to": { month: 4, day: 4 } },
                { "row": 4, "from": { month: 4, day: 5 }, "to": { month: 5, day: 5 } },
                { "row": 5, "from": { month: 5, day: 6 }, "to": { month: 6, day: 5 } },
                { "row": 6, "from": { month: 6, day: 6 }, "to": { month: 7, day: 7 } },
                { "row": 7, "from": { month: 7, day: 8 }, "to": { month: 8, day: 7 } },
                { "row": 8, "from": { month: 8, day: 8 }, "to": { month: 9, day: 7 } },
                { "row": 9, "from": { month: 9, day: 8 }, "to": { month: 10, day: 8 } },
                { "row": 10, "from": { month: 10, day: 9 }, "to": { month: 11, day: 7 } },
                { "row": 11, "from": { month: 11, day: 8 }, "to": { month: 12, day: 7 } },
                { "row": 12, "from": { month: 12, day: 8 }, "to": { month: 12, day: 31 } }
            ];

            const userDate = new Date(year, month - 1, day);

            for (const item of tableRanges) {
                const fromMonth = item.from.month;
                const fromDay = item.from.day;
                const toMonth = item.to.month;
                const toDay = item.to.day;

                const dateFrom = new Date(year, fromMonth - 1, fromDay);
                const dateTo = new Date(year, toMonth - 1, toDay);

                if (item.row === 0) { // This is the Jan 1-5 special case
                    if (userDate >= dateFrom && userDate <= dateTo) {
                        return 12; // Maps to "month 12" in male/female tables
                    }
                } else { // Standard rows
                    if (userDate >= dateFrom && userDate <= dateTo) {
                        return item.row; // Returns 1-12
                    }
                }
            }
            return -1; // Date not found in any range (shouldn't happen with full date range)
        }

        function calculateNatalAffinityZone(day, month, year, gender) {
            if (isNaN(day) || isNaN(month) || isNaN(year) || !(month >= 1 && month <= 12 && day >= 1 && day <= 31)) {
                throw new Error("Invalid month or day. Please ensure all fields are selected and valid numbers.");
            }
            if (!(year >= 1919 && year <= 2030)) {
                throw new Error("Year out of supported range (1919-2030).");
            }
            if (gender !== "male" && gender !== "female") {
                throw new Error("Gender must be 'male' or 'female'.");
            }

            const maleLookup = {
                1: { "1": "G", "2": "A", "3": "D", "4": "A", "5": "A", "6": "D", "7": "A", "8": "G", "9": "B" },
                2: { "1": "G", "2": "B", "3": "G", "4": "A", "5": "B", "6": "G", "7": "A", "8": "D", "9": "A" },
                3: { "1": "D", "2": "A", "3": "D", "4": "B", "5": "A", "6": "D", "7": "B", "8": "G", "9": "B" },
                4: { "1": "G", "2": "B", "3": "G", "4": "A", "5": "B", "6": "G", "7": "A", "8": "D", "9": "A" },
                5: { "1": "D", "2": "A", "3": "G", "4": "B", "5": "A", "6": "G", "7": "B", "8": "G", "9": "A" },
                6: { "1": "G", "2": "B", "3": "D", "4": "A", "5": "B", "6": "D", "7": "A", "8": "D", "9": "B" },
                7: { "1": "D", "2": "A", "3": "G", "4": "B", "5": "A", "6": "G", "7": "B", "8": "G", "9": "A" },
                8: { "1": "G", "2": "A", "3": "D", "4": "A", "5": "A", "6": "D", "7": "A", "8": "G", "9": "B" },
                9: { "1": "D", "2": "B", "3": "G", "4": "B", "5": "B", "6": "G", "7": "B", "8": "D", "9": "A" },
                10: { "1": "G", "2": "A", "3": "D", "4": "A", "5": "A", "6": "D", "7": "A", "8": "G", "9": "B" },
                11: { "1": "G", "2": "B", "3": "G", "4": "A", "5": "B", "6": "G", "7": "A", "8": "D", "9": "A" },
                12: { "1": "D", "2": "A", "3": "D", "4": "B", "5": "A", "6": "D", "7": "B", "8": "G", "9": "B" }
            };
            const femaleLookup = {
                1: { "1": "G", "2": "A", "3": "D", "4": "A", "5": "G", "6": "D", "7": "A", "8": "G", "9": "B" },
                2: { "1": "D", "2": "B", "3": "G", "4": "B", "5": "D", "6": "G", "7": "B", "8": "D", "9": "A" },
                3: { "1": "D", "2": "A", "3": "D", "4": "B", "5": "G", "6": "D", "7": "B", "8": "G", "9": "B" },
                4: { "1": "G", "2": "B", "3": "G", "4": "A", "5": "D", "6": "G", "7": "A", "8": "D", "9": "A" },
                5: { "1": "D", "2": "A", "3": "D", "4": "B", "5": "G", "6": "D", "7": "B", "8": "G", "9": "B" },
                6: { "1": "G", "2": "B", "3": "D", "4": "A", "5": "D", "6": "D", "7": "A", "8": "D", "9": "B" },
                7: { "1": "D", "2": "A", "3": "G", "4": "B", "5": "G", "6": "G", "7": "B", "8": "G", "9": "A" },
                8: { "1": "G", "2": "B", "3": "D", "4": "A", "5": "D", "6": "D", "7": "A", "8": "D", "9": "B" },
                9: { "1": "D", "2": "B", "3": "G", "4": "B", "5": "D", "6": "G", "7": "B", "8": "D", "9": "A" },
                10: { "1": "G", "2": "A", "3": "D", "4": "A", "5": "G", "6": "D", "7": "A", "8": "G", "9": "B" },
                11: { "1": "D", "2": "B", "3": "G", "4": "B", "5": "D", "6": "G", "7": "B", "8": "D", "9": "A" },
                12: { "1": "D", "2": "A", "3": "D", "4": "B", "5": "G", "6": "D", "7": "B", "8": "G", "9": "B" }
            };

            const affinityMap = {
                "D": "SS",
                "B": "DS",
                "A": "DD",
                "G": "SD"
            };

            let currentYear = year;
            let monthRowIndex = getMonthRow(day, month, currentYear);

            if (monthRowIndex === 12 && month === 1 && day <= 5) {
                currentYear -= 1;
            }

            const yearOrder = getYearOrder(currentYear);

            if (yearOrder === -1) {
                throw new Error("Year order could not be determined for the adjusted year.");
            }

            let letterCode;
            if (gender === "male") {
                letterCode = maleLookup[monthRowIndex][String(yearOrder)];
            } else { // female
                letterCode = femaleLookup[monthRowIndex][String(yearOrder)];
            }

            return affinityMap[letterCode] || "UNKNOWN_TYPE";
        }

        // --- Main Event Listener and Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const generateReportBtn = document.getElementById('generateReportBtn');
            const resultDiv = document.getElementById('resultDiv');
            const loadingMessage = document.getElementById('loadingMessage');
            const downloadLink = document.getElementById('downloadReportLink'); // Changed to downloadLink

            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async () => {
                    console.log('Generate button clicked.'); // DEBUG LOG

                    const nameA = document.getElementById('nameA').value.trim();
                    const dayA = parseInt(document.getElementById('dayA').value);
                    const monthA = parseInt(document.getElementById('monthA').value);
                    const yearA = parseInt(document.getElementById('yearA').value);
                    const genderA = document.getElementById('genderA').value;

                    const nameB = document.getElementById('nameB').value.trim();
                    const dayB = parseInt(document.getElementById('dayB').value);
                    const monthB = parseInt(document.getElementById('monthB').value);
                    const yearB = parseInt(document.getElementById('yearB').value);
                    const genderB = document.getElementById('genderB').value;

                    resultDiv.innerHTML = '';
                    downloadLink.classList.add('hidden'); // Use downloadLink
                    loadingMessage.classList.remove('hidden');
                    console.log('UI state reset, loading message shown.'); // DEBUG LOG

                    try {
                        const affinityA = calculateNatalAffinityZone(dayA, monthA, yearA, genderA);
                        const affinityB = calculateNatalAffinityZone(dayB, monthB, yearB, genderB);

                        // Canonical sorting for the relationship key (e.g., "SS-SD" vs "SD-SS" becomes "SD-SS")
                        const sortedAffinities = [affinityA, affinityB].sort();
                        let relationshipKey = sortedAffinities.join('-');
                        console.log('Calculated relationship key:', relationshipKey); // DEBUG LOG

                        // Fetch report content from the specific HTML file in the 'reports' folder
                        const reportFilePath = `reports/${relationshipKey.toLowerCase()}.html`;
                        console.log('Attempting to fetch report from:', reportFilePath); // DEBUG LOG
                        const response = await fetch(reportFilePath);
                        console.log('Fetch response status:', response.status); // DEBUG LOG
                        console.log('Fetch response OK:', response.ok); // DEBUG LOG

                        if (!response.ok) {
                            console.error('Fetch was not OK. Response status:', response.status); // DEBUG LOG
                            throw new Error(`Report content not found for ${relationshipKey} (Status: ${response.status}). Please ensure 'reports/${relationshipKey.toLowerCase()}.html' exists and is accessible.`);
                        }

                        const reportContent = await response.text();
                        console.log('Fetched report content length:', reportContent.length); // DEBUG LOG
                        console.log('Fetched report content (first 200 chars):', reportContent.substring(0, 200)); // DEBUG LOG
                        
                        if (reportContent.trim().length === 0 || reportContent.includes('<!DOCTYPE html>')) { // Check for empty or full HTML
                            console.error('Report file content is empty or contains full HTML structure:', reportContent.substring(0, 50)); // DEBUG LOG
                            throw new Error(`Report file for ${relationshipKey} is empty or contains unexpected full HTML structure. Ensure it only contains the report section.`);
                        }

                        // Replace placeholders for dynamic data within the fetched insight
                        let processedReportContent = reportContent
                            .replace(/PERSON_A_GENDER/g, genderA)
                            .replace(/PERSON_B_GENDER/g, genderB)
                            .replace(/PERSON_A_NAME/g, nameA)
                            .replace(/PERSON_B_NAME/g, nameB)
                            .replace(/AFFINITY_A/g, affinityA)
                            .replace(/AFFINITY_B/g, affinityB);
                        console.log('Placeholders processed.'); // DEBUG LOG

                        // The HTML to display in the resultDiv
                        let finalReportHtmlForDisplay = `
                            <p class="text-2xl font-semibold mb-6 text-center text-gray-900">
                                The Sacred Connection Between ${nameA} (${affinityA}) and ${nameB} (${affinityB}):
                                <br class="hidden md:block"> A Journey into their Unique ${affinityA}-${affinityB} Relationship
                            </p>
                            ${processedReportContent}
                        `;
                        resultDiv.innerHTML = finalReportHtmlForDisplay;
                        console.log('resultDiv innerHTML set.'); // DEBUG LOG
                        console.log('resultDiv clientHeight after content:', resultDiv.clientHeight); // DEBUG LOG
                        
                        downloadLink.classList.remove('hidden'); // Use downloadLink
                        console.log('Report displayed successfully, download link shown.'); // DEBUG LOG

                        // Set up download link functionality using a temporary anchor element
                        downloadLink.onclick = (event) => { // Added event parameter
                            event.preventDefault(); // Prevent default link behavior
                            console.log('Download link clicked inside handler.'); // DEBUG LOG

                            // Construct the full HTML for download separately
                            const downloadReportBodyContent = `
                                <h1 style="font-size: 2.2em; text-align: center; color: #1a202c; margin-bottom: 0.8em;">AZONE AI Relationship Report for ${nameA} and ${nameB}</h1>
                                <p style="font-size: 1.8em; text-align: center; color: #2d3748; margin-top: 1.5em; margin-bottom: 0.7em;">
                                    The Sacred Connection Between ${nameA} (${affinityA}) and ${nameB} (${affinityB}):
                                    <br> A Journey into their Unique ${affinityA}-${affinityB} Relationship
                                </p>
                                ${processedReportContent}
                            `;
                            console.log('Download HTML body content prepared.'); // DEBUG LOG

                            const downloadHtml = `
                                <!DOCTYPE html>
                                <html lang="en">
                                <head>
                                    <meta charset="UTF-8">
                                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                    <title>AZONE AI Relationship Report - ${nameA} & ${nameB}</title>
                                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                                    <style>
                                        body { font-family: 'Inter', sans-serif; line-height: 1.8; color: #333; max-width: 850px; margin: 0 auto; padding: 25px; background-color: #f9fafb; }
                                        h1 { font-size: 2.2em; text-align: center; color: #1a202c; margin-bottom: 0.8em; }
                                        h2 { font-size: 1.8em; color: #2d3748; margin-top: 1.5em; margin-bottom: 0.7em; }
                                        h3 { font-size: 1.5em; color: #2d3748; margin-top: 1.2em; margin-bottom: 0.6em; }
                                        h4 { font-size: 1.25em; color: #4a5568; margin-top: 1em; margin-bottom: 0.5em; }
                                        p { margin-bottom: 1em; }
                                        ul { list-style-type: disc; margin-left: 25px; margin-bottom: 1em; }
                                        li { margin-bottom: 0.5em; }
                                        b, strong { font-weight: 600; color: #2c3e50; }
                                        .report-section { border-bottom: 1px solid #e2e8f0; padding-bottom: 1.5em; margin-bottom: 1.5em; }
                                        .report-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
                                    </style>
                                </head>
                                <body>
                                    ${downloadReportBodyContent}
                                </body>
                                </html>
                            `;
                            console.log('Full download HTML prepared.'); // DEBUG LOG

                            try {
                                const blob = new Blob([downloadHtml], { type: 'text/html' });
                                const tempUrl = URL.createObjectURL(blob); // Create temporary URL
                                
                                const tempLink = document.createElement('a'); // Create a temporary link element
                                tempLink.href = tempUrl;
                                tempLink.download = `AZONE_Report_${nameA}_${nameB}.html`;
                                tempLink.style.display = 'none'; // Hide it
                                document.body.appendChild(tempLink); // Append to body
                                tempLink.click(); // Programmatically click
                                document.body.removeChild(tempLink); // Clean up
                                URL.revokeObjectURL(tempUrl); // Revoke URL
                                console.log('Download triggered successfully using temporary link.'); // DEBUG LOG
                            } catch (downloadError) {
                                console.error('Error during download process:', downloadError); // DEBUG LOG
                                // You could display a user-friendly message here if needed
                            }
                        };

                    } catch (error) {
                        console.error('Error during report generation (caught):', error); // DEBUG LOG
                        resultDiv.innerHTML = `<p class="text-red-500 text-center">Error: ${error.message}</p>`;
                        resultDiv.style.display = 'block';
                    } finally {
                        loadingMessage.classList.add('hidden');
                        console.log('Loading message hidden.'); // DEBUG LOG
                    }
                });
            }
        });
    </script>
</body>
</html>
